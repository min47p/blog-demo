{{ if ne .Params.math false }}
{{ $v := .Site.Params.katexVersion | default "0.16" }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@{{ $v }}/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@{{ $v }}/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@{{ $v }}/dist/contrib/auto-render.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  // Render math
  renderMathInElement(document.body, {
    delimiters: [
      {left: '$$', right: '$$', display: true},
      {left: '$', right: '$', display: false},
      {left: '\\[', right: '\\]', display: true},
      {left: '\\(', right: '\\)', display: false}
    ]
  });

  // Get all display equations in document order
  var displays = Array.from(document.querySelectorAll(".katex-display"));

  // Assign numbers to equations
  displays.forEach(function(el, i) {
    el.setAttribute("data-eq-num", i + 1);
  });

  // Build map of named labels to equation numbers
  var eqNumbers = {};
  document.querySelectorAll(".eq-label[id^='eq-']").forEach(function(anchor) {
    var name = anchor.id.substring(3);
    // Find the first equation that comes after this anchor in DOM order
    for (var i = 0; i < displays.length; i++) {
      // Check if anchor comes before this display equation
      if (anchor.compareDocumentPosition(displays[i]) & Node.DOCUMENT_POSITION_FOLLOWING) {
        eqNumbers[name] = i + 1;
        break;
      }
    }
  });

  // Update eqref links with actual numbers (link to the named anchor)
  document.querySelectorAll("a.eq-ref[data-eq]").forEach(function(link) {
    var name = link.getAttribute("data-eq");
    var num = eqNumbers[name];
    if (num) {
      link.textContent = "(" + num + ")";
      // Keep linking to the named anchor, not the number
    }
  });
});
</script>
{{ end }}
